name: Update Homebrew Formula

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get release information
        id: release
        run: |
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          tag="${{ github.event.release.tag_name }}"
          echo "version=${tag#v}" >> $GITHUB_OUTPUT

      - name: Download and calculate SHA256
        id: sha256
        run: |
          wget -q "https://github.com/marcfrederick/assume/archive/refs/tags/${{ steps.release.outputs.tag }}.tar.gz"
          sha256=$(sha256sum "${{ steps.release.outputs.tag }}.tar.gz" | cut -d' ' -f1)
          echo "sha256=$sha256" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v5
        with:
          repository: marcfrederick/homebrew-tap
          path: tap-repo
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          fetch-depth: 0

      - name: Update formula
        run: |
          cd tap-repo
          mkdir -p Formula

          cat > Formula/assume.rb << 'EOF'
          class Assume < Formula
            desc      "Interactive AWS profile switcher with automatic SSO login support"
            homepage "https://github.com/marcfrederick/assume"
            url      "https://github.com/marcfrederick/assume/archive/refs/tags/${{ steps.release.outputs.tag }}.tar.gz"
            sha256   "${{ steps.sha256.outputs.sha256 }}"
            license   "GPL-3.0-or-later"
            head      "https://github.com/marcfrederick/assume.git", branch: "main"

            depends_on "awscli"
            depends_on "bash"
            depends_on "fzf"

            def install
              bin.install "assume"
            end

            def caveats
              <<~EOS
                To use assume as a shell function that sets environment variables in your current shell,
                add the following to your shell configuration file:

                For Bash/Zsh (~/.bashrc or ~/.zshrc):
                  assume() {
                    eval "$(command assume "$@")"
                  }

                For Fish (~/.config/fish/config.fish):
                  function assume
                      eval (command assume $argv)
                  end

                Then restart your shell or source your configuration file.
              EOS
            end

            test do
              assert_predicate bin/"assume", :exist?
              assert_predicate bin/"assume", :executable?
            end
          end
          EOF

      - name: Commit and push changes
        run: |
          cd tap-repo
          git add Formula/assume.rb

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update assume formula to ${{ steps.release.outputs.tag }}"
          git push origin HEAD:main
